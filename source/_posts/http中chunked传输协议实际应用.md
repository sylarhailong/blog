---
title: http中chunked传输协议实际应用
date: 2017-09-03 09:18:46
categories: java
tags: 
    - chunked
    - 加载速度优化
---
### 分块传输编码简介
**分块传输编码**(**Chunked transfer encoding**)是超文本传输协议（HTTP）中的一种数据传输机制，允许HTTP由网页服务器发送给客户端应用（ 通常是网页浏览器）的数据可以分成多个部分。分块传输编码只在HTTP协议1.1版本（HTTP/1.1）中提供。

通常，HTTP应答消息中发送的数据是整个发送的，Content-Length消息头字段表示数据的长度。数据的长度很重要，因为客户端需要知道哪里是应答消息的结束，以及后续应答消息的开始。然而，使用分块传输编码，数据分解成一系列数据块，并以一个或多个块发送，这样服务器可以发送数据而不需要预先知道发送内容的总大小。通常数据块的大小是一致的，但也不总是这种情况。

#### 原理
HTTP 1.1引入分块传输编码提供了以下几点好处

* HTTP分块传输编码允许服务器为动态生成的内容维持HTTP持久链接。通常，持久链接需要服务器在开始发送消息体前发送Content-Length消息头字段，但是对于动态生成的内容来说，在内容创建完之前是不可知的.
* 分块传输编码允许服务器在最后发送消息头字段。对于那些头字段值在内容被生成之前无法知道的情形非常重要，例如消息的内容要使用散列进行签名，散列的结果通过HTTP消息头字段进行传输。没有分块传输编码时，服务器必须缓冲内容直到完成后计算头字段的值并在发送内容前发送这些头字段的值。
* HTTP服务器有时使用压缩 （gzip或deflate）以缩短传输花费的时间。分块传输编码可以用来分隔压缩对象的多个部分。在这种情况下，块不是分别压缩的，而是整个负载进行压缩，压缩的输出使用本文描述的方案进行分块传输。在压缩的情形中，分块编码有利于一边进行压缩一边发送数据，而不是先完成压缩过程以得知压缩后数据的大小。

#### 格式
如果一个HTTP消息（请求消息或应答消息）的Transfer-Encoding消息头的值为chunked，那么，消息体由数量未定的块组成，并以最后一个大小为0的块为结束。

每一个非空的块都以该块包含数据的字节数（字节数以十六进制表示）开始，跟随一个CRLF （回车及换行），然后是数据本身，最后块CRLF结束。在一些实现中，块大小和CRLF之间填充有白空格（0x20）。

最后一块是单行，由块大小（0），一些可选的填充白空格，以及CRLF。最后一块不再包含任何数据，但是可以发送可选的尾部，包括消息头字段。
消息最后以CRLF结尾。

### chunked实际应用
#### 应用背景
本网站是使用nginx+resin的整体架构，使用java开发
#### 应用收益
考虑到分片传输可以分片将页面吐出去，考虑先将html中head的部分吐给浏览器，head部分包含公共的js和css，浏览器收到内容后会请求这些资源，而同时前端web程序会开始执行业务逻辑，达到并行的效果，等web程序运行完成再吐一次数据给浏览器，从而达到减少页面加载时间的效果，提高页面的整体加载速度。
#### 应用方案
* 1.运维同学在nginx上配置，支持chunked协议，在nginx 0.7.66版本之后，有一个配置项chunked_transfer_encoding可以开启或者关闭chunk模式，默认是开启的。
    ```
    chunked_transfer_encoding on | off;
    ```
* 2.修改java代码逻辑支持分片发送给浏览器，使用 out.flush();就会将该语句之前的内容发送给浏览器，可以多次使用，在代码的最底部在加上一个，将最后的内容发送出去，每种语言写法不同
    * PHP:    ob_flush(); flush();
    * perl:   STDOUT->autoflush(1);
    * Java:  out.flush();
    * Python:  sys.stdout.flush()
    * ruby:  stdout.flush
* 3.修改代业务逻辑放到&lt; /head>之后，&lt; /head>之后flush因此

#### 应用踩坑
由于flush之后，再向response中设置任何东西都会失效，比如在业务逻辑中会有设置cookie的逻辑，要把它放到页面中去设值。需要仔细梳理response中的业务逻辑，避免影响广告收入和统计结果

#### 应用效果
经过小流量上线试验后，页面加载时间较少**150ms**，全量上线后，页面加载时间减少**200ms**，效果比较明显

#### 应用建议
如果网站加载时间优化在前端css和js已经优化的没有空间了，可以考虑下这种方案

### 参考资料
* [维基百科](https://zh.wikipedia.org/wiki/分块传输编码)
* [http chunked传输](http://blog.csdn.net/ruby1098/article/details/6730424)
    

